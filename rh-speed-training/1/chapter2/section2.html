<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Bonus Exercise: Automate the people! :: Red Hat Speed Training Labs</title>
    <link rel="prev" href="section1.html">
    <link rel="next" href="../chapter3/index.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Red Hat Speed Training Labs</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/changeme/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="rh-speed-training" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Red Hat Speed Training Labs</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../chapter1/index.html">What the heck is Git?</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter1/section1.html">Exercise: Let&#8217;s Git our hands dirty!</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter1/section2.html">Bonus Exercise: Git outta town!</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Ansible Everywhere</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section1.html">Exercise: Automate this!</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="section2.html">Bonus Exercise: Automate the people!</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../chapter3/index.html">Can&#8217;t contain their value!</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter3/section1.html">Exercise: Can&#8217;t contain the need to get hands-on!</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter3/section2.html">Bonus Exercise: Can&#8217;t contain your progress!</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendix/appendix.html">Appendix</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Red Hat Speed Training Labs</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Red Hat Speed Training Labs</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Red Hat Speed Training Labs</a></li>
    <li><a href="index.html">Ansible Everywhere</a></li>
    <li><a href="section2.html">Bonus Exercise: Automate the people!</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Bonus Exercise: Automate the people!</h1>
<div class="sect1">
<h2 id="_acknowledgements"><a class="anchor" href="#_acknowledgements"></a>Acknowledgements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All credit for the steps in this exercise and the associated lab environment you are using go to the Red Hat Training development team! Find more fun exercises like this on Ansible in one of our many automation courses including: Linux Automation with Ansible (RH294), Network Automation with the Ansible Automation Platform (DO457), or Windows Automation with the Ansible Automation Platform (DO417). <strong>Ask a Red Hat team member about how you can continue your learning with a Red Hat Learning Subscription or through general Red Hat Training courses!</strong></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_goals"><a class="anchor" href="#_goals"></a>Goals</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Create a new user group.</p>
</li>
<li>
<p>Manage users by using the <code>ansible.builtin.user</code> module.</p>
</li>
<li>
<p>Populate SSH authorized keys by using the <code>ansible.posix.authorized_key</code> module.</p>
</li>
<li>
<p>Modify the <code>/etc/ssh/sshd_config</code> file and a configuration file in <code>/etc/sudoers.d</code> by using the <code>ansible.builtin.lineinfile</code> module.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As the <code>student</code> user on the <code>workstation</code> machine, use the <code>lab</code> command to prepare your system for this exercise.</p>
</div>
<div class="paragraph">
<p>This command prepares your environment and ensures that all required resources are available.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[student@workstation ~]$ <strong>lab start system-users</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect1 Checklist">
<h2 id="_instructions"><a class="anchor" href="#_instructions"></a>Instructions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Your organization requires that all hosts have the same local users available. These users should belong to the <code>webadmin</code> user group, which can use the <code>sudo</code> command without specifying a password. Also, the users' SSH public keys should be distributed in the environment to their <code>~/.ssh/authorized_keys</code> files to allow key-based authentication, and the <code>root</code> user should not be allowed to log in directly using SSH.</p>
</div>
<div class="paragraph">
<p>Write a playbook to ensure that the users specified in the <code>/home/student/system-users/vars/users_vars.yml</code> file and the <code>webadmin</code> user group are present on the managed hosts and meet the preceding criteria.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Change into the <code>/home/student/system-users</code> directory.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>[student@workstation ~]$ <strong>cd ~/system-users</strong>
[student@workstation system-users]$</pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Examine the existing <code>vars/users_vars.yml</code> variable file.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>---
users:
  - username: user1
    groups: webadmin
  - username: user2
    groups: webadmin
  - username: user3
    groups: webadmin
  - username: user4
    groups: webadmin
  - username: user5
    groups: webadmin</pre>
</div>
</div>
<div class="paragraph">
<p>It uses the <code>username</code> variable name to set the correct username, and the <code>groups</code> variable to define supplementary groups that the user should belong to.</p>
</div>
</div>
</div>
</li>
<li>
<p>Start writing the <code>/home/student/system-users/users.yml</code> playbook. Define a single play in the playbook that targets the <code>webservers</code> host group.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Add a <code>vars_files</code> clause that loads the variables in the <code>vars/users_vars.yml</code> file, which has been created for you, and which contains all the usernames that are required for this exercise.</p>
</div>
<div class="paragraph">
<p>Add the <code>tasks</code> clause to the playbook.</p>
</div>
<div class="paragraph">
<p>The <code>users.yml</code> playbook should consist of the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>---
- name: Create multiple local users
  hosts: webservers
  vars_files:
    - vars/users_vars.yml
  tasks:</pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Add two tasks to the play.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Create the <code>webadmin</code> user group on the managed hosts by using the <code>ansible.builtin.group</code> module in the first task.</p>
</div>
<div class="paragraph">
<p>Create the users specified in the <code>vars/users_vars.yml</code> file by using the <code>ansible.builtin.user</code> module to loop over those variables in the second task.</p>
</div>
<div class="paragraph">
<p>Run the <code>users.yml</code> playbook.</p>
</div>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Add the first task to the play to ensure that the group <code>webadmin</code> exists on your managed hosts.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>The first task should consist of the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    - name: Add webadmin group
      ansible.builtin.group:
        name: webadmin
        state: present</pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Add a second task to the play that uses the <code>ansible.builtin.user</code> module to ensure that the users exist on your managed hosts.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Add a <code>loop: "{{ users }}"</code> clause to the task to iterate over every user found in the <code>vars/users_vars.yml</code> file.</p>
</div>
<div class="paragraph">
<p>For the <code>name</code> parameter for the users, use <code>item['username']</code>, not <code>item</code>. This allows each list item in the variable file to be structured as a dictionary of multiple variables that includes additional information about each user in the list, specifically which supplementary groups the user should be a member of.</p>
</div>
<div class="paragraph">
<p>The entire playbook should consist of the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>---
- name: Create multiple local users
  hosts: webservers
  vars_files:
    - vars/users_vars.yml
  tasks:

    - name: Add webadmin group
      ansible.builtin.group:
        name: webadmin
        state: present

    - name: Create user accounts
      ansible.builtin.user:
        name: "{{ item['username'] }}"
        groups: "{{ item['groups'] }}"
      loop: "{{ users }}"</pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Run the <code>users.yml</code> playbook:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>[student@workstation system-users]$ <strong>ansible-navigator run \</strong>
 <strong>-m stdout users.yml</strong>

PLAY [Create multiple local users] *******************************************

TASK [Gathering Facts] *******************************************************
ok: [servera.lab.example.com]

TASK [Add webadmin group] ****************************************************
changed: [servera.lab.example.com]

TASK [Create user accounts] **************************************************
changed: [servera.lab.example.com] =&gt; (item={'username': 'user1', 'groups': 'webadmin'})
changed: [servera.lab.example.com] =&gt; (item={'username': 'user2', 'groups': 'webadmin'})
changed: [servera.lab.example.com] =&gt; (item={'username': 'user3', 'groups': 'webadmin'})
changed: [servera.lab.example.com] =&gt; (item={'username': 'user4', 'groups': 'webadmin'})
changed: [servera.lab.example.com] =&gt; (item={'username': 'user5', 'groups': 'webadmin'})

PLAY RECAP *******************************************************************
servera.lab.example.com    : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Ensure the SSH public keys have been properly distributed to the managed hosts by adding a third task to the play that uses the <code>ansible.posix.authorized_key</code> module.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>In the <code>files</code> directory, each user has a unique SSH public key file. The module loops through the list of users, finds the appropriate key by using the <code>username</code> variable, and pushes the key to the managed host.</p>
</div>
<div class="paragraph">
<p>For the <code>key</code> parameter, use the following Jinja2 expression for its value to evaluate the contents of the appropriate public key file. A lookup function is used with the <code>file</code> plug-in to read the file, and its file name is constructed using string operations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>"{{ lookup('file', 'files/'+ item['username'] + '.key.pub') }}"</pre>
</div>
</div>
<div class="paragraph">
<p>The third task should consist of the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    - name: Add authorized keys
      ansible.posix.authorized_key:
        user: "{{ item['username'] }}"
        key: "{{ lookup('file', 'files/'+ item['username'] + '.key.pub') }}"
      loop: "{{ users }}"</pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Add a fourth task to the play that uses the <code>ansible.builtin.lineinfile</code> module to modify the <code>sudo</code> configuration file and allow the <code>webadmin</code> group members to use <code>sudo</code> without a password on the managed host. Use the <code>validate</code> parameter to validate the new configuration entry.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>The fourth task should consist of the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    - name: Modify sudo config to allow webadmin users sudo without a password
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/webadmin
        state: present
        create: true
        mode: 0440
        line: "%webadmin ALL=(ALL) NOPASSWD: ALL"
        validate: /usr/sbin/visudo -cf %s</pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Add a fifth task to ensure that the <code>root</code> user is not permitted to log in using SSH directly. Use <code>notify: Restart sshd</code> to trigger a handler to restart SSH.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>The fifth task should consist of the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    - name: Disable root login via SSH
      ansible.builtin.lineinfile:
        dest: /etc/ssh/sshd_config
        regexp: "^PermitRootLogin"
        line: "PermitRootLogin no"
      notify: Restart sshd</pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>In the first line after the location of the variable file, add a new handler definition named <code>Restart sshd</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Define the <code>Restart sshd</code> handler as follows:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre><em>...output omitted...</em>
    - vars/users_vars.yml
  handlers:
    - name: Restart sshd
      ansible.builtin.service:
        name: sshd
        state: restarted</pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>The <code>users.yml</code> playbook should consist of the following content:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>---
- name: Create multiple local users
  hosts: webservers
  vars_files:
    - vars/users_vars.yml
  handlers:
    - name: Restart sshd
      ansible.builtin.service:
        name: sshd
        state: restarted

  tasks:
    - name: Add webadmin group
      ansible.builtin.group:
        name: webadmin
        state: present

    - name: Create user accounts
      ansible.builtin.user:
        name: "{{ item['username'] }}"
        groups: "{{ item['groups'] }}"
      loop: "{{ users }}"

    - name: Add authorized keys
      ansible.posix.authorized_key:
        user: "{{ item['username'] }}"
        key: "{{ lookup('file', 'files/'+ item['username'] + '.key.pub') }}"
      loop: "{{ users }}"

    - name: Modify sudo config to allow webadmin users sudo without a password
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/webadmin
        state: present
        create: true
        mode: 0440
        line: "%webadmin ALL=(ALL) NOPASSWD: ALL"
        validate: /usr/sbin/visudo -cf %s

    - name: Disable root login via SSH
      ansible.builtin.lineinfile:
        dest: /etc/ssh/sshd_config
        regexp: "^PermitRootLogin"
        line: "PermitRootLogin no"
      notify: Restart sshd</pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Run the <code>users.yml</code> playbook.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>[student@workstation system-users]$ <strong>ansible-navigator run \</strong>
 <strong>-m stdout users.yml</strong>

PLAY [Create multiple local users] *******************************************

TASK [Gathering Facts] *******************************************************
ok: [servera.lab.example.com]

TASK [Add webadmin group] ****************************************************
ok: [servera.lab.example.com]

TASK [Create user accounts] **************************************************
ok: [servera.lab.example.com] =&gt; (item={'username': 'user1', 'groups': 'webadmin'})
ok: [servera.lab.example.com] =&gt; (item={'username': 'user2', 'groups': 'webadmin'})
ok: [servera.lab.example.com] =&gt; (item={'username': 'user3', 'groups': 'webadmin'})
ok: [servera.lab.example.com] =&gt; (item={'username': 'user4', 'groups': 'webadmin'})
ok: [servera.lab.example.com] =&gt; (item={'username': 'user5', 'groups': 'webadmin'})

TASK [Add authorized keys] ***************************************************
changed: [servera.lab.example.com] =&gt; (item={'username': 'user1', 'groups': 'webadmin'})
changed: [servera.lab.example.com] =&gt; (item={'username': 'user2', 'groups': 'webadmin'})
changed: [servera.lab.example.com] =&gt; (item={'username': 'user3', 'groups': 'webadmin'})
changed: [servera.lab.example.com] =&gt; (item={'username': 'user4', 'groups': 'webadmin'})
changed: [servera.lab.example.com] =&gt; (item={'username': 'user5', 'groups': 'webadmin'})

TASK [Modify sudo config to allow webadmin users sudo without a password] ***
changed: [servera.lab.example.com]

TASK [Disable root login via SSH] *******************************************
changed: [servera.lab.example.com]

RUNNING HANDLER [Restart sshd] **********************************************
changed: [servera.lab.example.com]

PLAY RECAP ******************************************************************
servera.lab.example.com    : ok=7    changed=4    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Use SSH as the <code>user1</code> user and log in to the <code>servera</code> server. After logging in, use <code>sudo -i</code> command to change to the <code>root</code> user.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Use SSH as the <code>user1</code> user and log in to the <code>servera</code> server.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>[student@workstation system-users]$ <strong>ssh user1@servera</strong>
Register this system with Red Hat Insights: insights-client --register
Create an account or view all your systems at https://red.ht/insights-dashboard

[user1@servera ~]$</pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Change to the <code>root</code> user.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>[user1@servera ~]$ <strong>sudo -i</strong>
[root@servera ~]#</pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Log out of <code>servera</code>.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>[root@servera ~]# <strong>exit</strong>
logout
[user1@servera ~]$ <strong>exit</strong>
logout
Connection to servera closed.
[student@workstation system-users]$</pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Try to log in to <code>servera</code> as the <code>root</code> user directly. This step should fail because the SSH daemon configuration has been modified not to permit direct <code>root</code> user logins.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>From the <code>workstation</code> machine, use SSH as the <code>root</code> user and log in to the <code>servera</code> server.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>[student@workstation system-users]$ <strong>ssh root@servera</strong>
root@servera's password: <strong>redhat</strong>
Permission denied, please try again.
root@servera's password:</pre>
</div>
</div>
<div class="paragraph">
<p>This confirms that the SSH configuration denied direct access to the system for the <code>root</code> user.</p>
</div>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="section1.html">Exercise: Automate this!</a></span>
  <span class="next"><a href="../chapter3/index.html">Can&#8217;t contain their value!</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
